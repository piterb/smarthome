<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React Dashboard</title>
  <!--<script src="https://apis.google.com/js/api.js"></script>-->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://unpkg.com/tailwindcss@^2.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>

  <script type="text/babel">
  const CLIENT_ID = '330408379765-sd6nljvet6d83ccihrp2on9eueqf3604.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

	const ClockModule = () => {
      const [time, setTime] = React.useState(new Date());

      React.useEffect(() => {
        const interval = setInterval(() => {
          setTime(new Date());
        }, 1000);
        return () => clearInterval(interval);
      }, []);

      const formatTime = (date) => {
        return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      };

      const formatDate = (date) => {
        const options = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
        return date.toLocaleDateString('en-GB', options);
      };

      const formatZuluTime = (date) => {
        return date.toISOString().substring(11, 16) + ' Z';
      };

      return (
        <div className="bg-gray-800 p-4 rounded-md text-center">
          <h2 className="text-4xl">{formatTime(time)}</h2>
          <h3 className="text-xl">({formatZuluTime(time)})</h3>
          <p className="text-lg">{formatDate(time)}</p>
        </div>
      );
    };

	const WeatherModule = () => {
  const [weatherData, setWeatherData] = React.useState(null);
  const [forecastData, setForecastData] = React.useState(null);

  React.useEffect(() => {
    const fetchWeatherData = async () => {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=48.1486&longitude=17.1077&current_weather=true&hourly=temperature_2m,weathercode,winddirection_10m,windspeed_10m,pressure_msl`
        );
        const data = await response.json();
        setWeatherData(data.current_weather);
        setForecastData(data.hourly);
      } catch (error) {
        console.error("Error fetching weather data:", error);
      }
    };

	fetchWeatherData();
    const intervalId = setInterval(fetchWeatherData, 60000); // fetch every minute
    return () => clearInterval(intervalId); // Clean up interval on component unmount
  }, []);

  const weatherCodeToIcon = (code, isNight) => {
    const iconMap = {
      0: isNight ? 'https://img.icons8.com/ios-filled/50/FFFFFF/moon.png' : 'https://img.icons8.com/ios-filled/50/FFFFFF/sun.png', // Clear sky
      1: isNight ? 'https://img.icons8.com/ios-filled/50/FFFFFF/moon.png' : 'https://img.icons8.com/ios-filled/50/FFFFFF/sun.png', // Mainly clear
      2: isNight ? 'https://img.icons8.com/ios-filled/50/FFFFFF/partly-cloudy-night.png' : 'https://img.icons8.com/ios-filled/50/FFFFFF/partly-cloudy-day.png', // Partly cloudy
      3: 'https://img.icons8.com/ios-filled/50/FFFFFF/cloud.png', // Overcast
      45: isNight ? 'https://img.icons8.com/ios-filled/50/FFFFFF/fog-night.png' : 'https://img.icons8.com/ios-filled/50/FFFFFF/fog-day.png', // Fog
      48: isNight ? 'https://img.icons8.com/ios-filled/50/FFFFFF/fog-night.png' : 'https://img.icons8.com/ios-filled/50/FFFFFF/fog-day.png', // Depositing rime fog
      51: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Drizzle: Light
      53: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Drizzle: Moderate
      55: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Drizzle: Dense intensity
      61: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Rain: Slight
      63: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Rain: Moderate
      65: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Rain: Heavy intensity
      80: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Showers: Slight
      81: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Showers: Moderate
      82: 'https://img.icons8.com/ios-filled/50/FFFFFF/rain.png', // Showers: Violent
      95: 'https://img.icons8.com/ios-filled/50/FFFFFF/storm.png', // Thunderstorm: Slight or moderate
      96: 'https://img.icons8.com/ios-filled/50/FFFFFF/storm.png', // Thunderstorm: With slight hail
      99: 'https://img.icons8.com/ios-filled/50/FFFFFF/storm.png', // Thunderstorm: With heavy hail
    };
    return iconMap[code] || 'https://img.icons8.com/ios-filled/50/FFFFFF/cloud.png'; // Default to cloud if code not found
  };

  const weatherCodeToDescription = (code) => {
    const descriptionMap = {
      0: 'Clear sky',
      1: 'Mainly clear',
      2: 'Partly cloudy',
      3: 'Overcast',
      45: 'Fog',
      48: 'Depositing rime fog',
      51: 'Light drizzle',
      53: 'Moderate drizzle',
      55: 'Dense drizzle',
      61: 'Slight rain',
      63: 'Moderate rain',
      65: 'Heavy rain',
      80: 'Slight showers',
      81: 'Moderate showers',
      82: 'Violent showers',
      95: 'Slight or moderate thunderstorm',
      96: 'Thunderstorm with slight hail',
      99: 'Thunderstorm with heavy hail',
    };
    return descriptionMap[code] || 'Unknown';
  };

  if (!weatherData || !forecastData) {
    return <div>Loading...</div>;
  }

  const getDailyForecast = () => {
  const dailyData = [];
  const forecastTimes = forecastData.time.map(time => new Date(time));

  // Iterate over each day
  for (let i = 1; i <= 6; i++) {
    // Find the index for 12:00 PM of each day
    const middayIndex = forecastTimes.findIndex(time => 
      time.getDate() === new Date().getDate() + i && time.getHours() === 12
    );

    // Add the daily forecast data
    if (middayIndex !== -1) {
      dailyData.push({
        temperature: forecastData.temperature_2m[middayIndex],
        weathercode: forecastData.weathercode[middayIndex],
        date: forecastTimes[middayIndex]
      });
    }
  }

  return dailyData;
};


  const getHourlyForecast = () => {
    const hourlyData = [];
    const currentHour = new Date().getHours();
    // Find the index of the next full hour
    const startHourIndex = forecastData.time.findIndex(time => new Date(time).getHours() > currentHour);

    // Get the next 8 hours of forecast data
    for (let i = startHourIndex; i < startHourIndex + 8; i++) {
      hourlyData.push({
        temperature: forecastData.temperature_2m[i],
        weathercode: forecastData.weathercode[i],
        time: new Date(forecastData.time[i])
      });
    }
    return hourlyData;
  };

  // Determine if it is currently night
  const currentHour = new Date().getHours();
  const isNight = currentHour < 6 || currentHour > 18;
  const currentPressureIndex = forecastData.time.findIndex(time => new Date(time).getHours() === currentHour);
  const currentPressure = forecastData.pressure_msl[currentPressureIndex];

  return (
    <div className="bg-gray-800 p-4 rounded-md">
      <h3 className="text-2xl mb-2">Bratislava, Slovakia</h3>
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl">{Math.round(weatherData.temperature)}째</h2>
          <p className="flex items-center">
            <img src={weatherCodeToIcon(weatherData.weathercode, isNight)} alt="Weather Icon" className="w-6 h-6 mr-1" /> 
            {weatherCodeToDescription(weatherData.weathercode)}
          </p>
        </div>
        <div className="flex items-center">
          <img src="https://img.icons8.com/ios-filled/50/FFFFFF/windsock.png" alt="Wind" className="w-6 h-6 mr-1" />
          <p>{weatherData.winddirection}째/</p>
          <p>{Math.round(weatherData.windspeed * 1.94384)} kt</p>
        </div>
        <div className="flex items-center">
          <img src="https://img.icons8.com/ios-filled/50/FFFFFF/pressure.png" alt="Pressure" className="w-6 h-6 mr-1" />
          <p>{Math.round(currentPressure)} hPa</p>
        </div>
      </div>
      <div className="mt-4">
  <h3 className="text-xl">Forecast for next 6 days</h3>
  <div className="grid grid-cols-6 gap-2">
    {getDailyForecast().map((entry, index) => (
      <div key={index} className="text-center">
        <p>{entry.date.toLocaleDateString("en-GB", { weekday: "short" })}</p>
        <img src={weatherCodeToIcon(entry.weathercode, false)} alt="Weather Icon" className="w-6 h-6 mx-auto" />
        <p>{Math.round(entry.temperature)}째</p>
      </div>
    ))}
  </div>
</div>
      <div className="mt-4">
        <h3 className="text-xl">Forecast for next 8 hours</h3>
        <div className="grid grid-cols-8 gap-2">
          {getHourlyForecast().map((entry, index) => (
            <div key={index} className="text-center">
              <p>{entry.time.toLocaleTimeString("en-GB", { hour: "2-digit" })}</p>
              <img src={weatherCodeToIcon(entry.weathercode, entry.time.getHours() < 6 || entry.time.getHours() > 18)} alt="Weather Icon" className="w-6 h-6 mx-auto" />
              <p>{Math.round(entry.temperature)}째</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

const WeatherRadarModule = () => {
  return (
    <div className="bg-gray-800 p-4 rounded-md">
      <h3 className="text-xl mb-2">Weather Radar</h3>
      <iframe
        src="https://www.rainviewer.com/map.html?loc=48.0082,17.5392,6.283809968989212&oFa=0&oC=0&oU=0&oCS=1&oF=0&oAP=0&c=3&o=83&lm=1&layer=radar&mlayer=0&sm=1&sn=1&hu=false"
        width="100%"
        height="500"
        frameBorder="0"
        className="rounded-md"
        allowFullScreen
        title="Weather Radar"
      ></iframe>
    </div>
  );
};

const CalendarModule = () => {
  const [events, setEvents] = React.useState([]);
  const [isAuthenticated, setIsAuthenticated] = React.useState(false);
  const [token, setToken] = React.useState('');

  React.useEffect(() => {
    /* global google */
    const handleClientLoad = () => {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
      });
      google.accounts.id.renderButton(
        document.getElementById('signInDiv'),
        { theme: 'outline', size: 'large' }
      );
      google.accounts.id.prompt(); // Automatically prompt the user to sign in
    };

    const handleCredentialResponse = (response) => {
      console.log('Encoded JWT ID token: ' + response.credential);
      const decodedToken = parseJwt(response.credential);
      console.log('Decoded Token:', decodedToken);
      setToken(response.credential);
      setIsAuthenticated(true);
      listUpcomingEvents(response.credential);
    };

    const parseJwt = (token) => {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    };

    handleClientLoad();
  }, []);

  const listUpcomingEvents = (token) => {
    fetch(
      `https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=10&orderBy=startTime&singleEvents=true&timeMin=${new Date().toISOString()}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      }
    )
      .then((response) => {
        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
      })
      .then((data) => {
        const events = data.items;
        console.log('Events:', events);
        setEvents(events);
      })
      .catch((error) => {
        console.error('Error fetching events:', error);
      });
  };

  const handleSignoutClick = () => {
    setIsAuthenticated(false);
    setEvents([]);
    google.accounts.id.disableAutoSelect();
  };

  return (
    <div className="bg-gray-800 p-4 rounded-md">
      <h3 className="text-xl mb-2">Upcoming Events</h3>
      {!isAuthenticated ? (
        <div id="signInDiv"></div>
      ) : (
        <div>
          <button onClick={handleSignoutClick} className="bg-red-500 text-white p-2 rounded mb-4">Sign out</button>
          <ul className="grid grid-cols-5 gap-2">
            {events.map(event => (
              <li key={event.id} className="col-span-5">
                <div className="text-right">{new Date(event.start.dateTime || event.start.date).toLocaleDateString()}</div>
                <div className="text-left col-span-4">{new Date(event.start.dateTime || event.start.date).toLocaleTimeString()} - {event.summary}</div>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};


const latLonToTile = (lat, lon, zoom) => {
  const latRad = (lat * Math.PI) / 180;
  const n = 2 ** zoom;
  const xTile = Math.floor(((lon + 180) / 360) * n);
  const yTile = Math.floor(
    ((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2) * n
  );
  return { x: xTile, y: yTile };
};

	
    const Dashboard = () => {
      return (
        <div className="p-4 bg-gray-900 text-white min-h-screen">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Left Column */}
            <div className="space-y-4">
              {/* Date and Time Module */}
              <ClockModule />
              {/* Weather Module */}
			        <WeatherModule />
              {/* Weather Radar Module */}
              <WeatherRadarModule />
            </div>

            {/* Right Column */}
            <div className="bg-gray-800 p-4 rounded-md">
            <CalendarModule />
            </div>

          </div>
        </div>
      );
    };

    ReactDOM.render(<Dashboard />, document.getElementById('root'));
  </script>
</body>
</html>
